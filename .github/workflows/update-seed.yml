name: Update Seed Data

on:
  schedule:
    # Run every 6 hours to match the app's scrape interval
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-seed:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Run scraper and update seed
        run: |
          python3 << 'EOF'
          import sqlite3
          import json
          from datetime import datetime
          from pathlib import Path

          # Import app modules
          import sys
          sys.path.insert(0, '.')
          from app import init_db, run_scrape, DB_PATH, get_db_connection

          # Use local path for CI
          import app
          app.DB_PATH = Path("jackets.db")

          # Initialize and load existing seed
          init_db()

          # Run the scrape to get latest data
          print(f"[{datetime.now()}] Running scrape...")
          run_scrape()

          # Export updated data to seed.json
          conn = get_db_connection()
          conn.row_factory = sqlite3.Row
          c = conn.cursor()

          c.execute('SELECT * FROM daily_index ORDER BY date')
          daily_index = [dict(row) for row in c.fetchall()]

          c.execute('SELECT * FROM listings')
          listings = [dict(row) for row in c.fetchall()]
          conn.close()

          seed_data = {
              'daily_index': daily_index,
              'listings': listings,
              'exported_at': datetime.now().isoformat()
          }

          Path('data').mkdir(exist_ok=True)
          with open('data/seed.json', 'w') as f:
              json.dump(seed_data, f, indent=2, default=str)

          print(f"Exported {len(daily_index)} daily_index rows")
          print(f"Exported {len(listings)} listings")
          EOF
      
      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/seed.json
          git diff --staged --quiet || git commit -m "chore: update seed data [$(date -u +%Y-%m-%dT%H:%M:%SZ)]"
          git push
